<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="fragments/general :: allBaseLibs"/>
<th:block th:replace="fragments/buttons :: interactiveDeletionProcess" />
<th:block th:replace="fragments/libs :: bootstrap-datatable"/>

<th:block th:replace="fragments/table :: adminTableDefinition(${changeEnabled})"/>

<th:block th:replace="fragments/nav :: publicationListBar"/>

<button id="btDeleteDisplayedPapers" class="btn btn-danger mt-4 pr-4 pl-4"
	th:if="${changeEnabled}" th:utext="#{html.DeleteDisplayedPublications}"></button>

<table th:replace="fragments/table :: adminTable(~{::thead}, ~{::tbody})">
    <thead>
        <th th:text="#{html.Id}"></th>
        <th th:utext="#{html.Title}"></th>
        <th th:utext="#{html.Authors}"></th>
        <th th:utext="#{html.Type}"></th>
        <th th:utext="#{html.Year}"></th>
        <th th:utext="#{html.WherePublished}"></th>
        <th th:utext="#{html.OpenAccess}"></th>
        <th th:utext="#{html.Files}"></th>
        <th th:utext="#{html.Validated}"></th>
        <th th:text="#{html.Actions}"></th>
    </thead>
    <tbody>
        <tr th:each="publication : ${publications}">
            <td>
                <th:block th:utext="${publication.id}"></th:block>
            </td>
            <td>
            	<th:block th:if="${#bools.isTrue(publication.manualValidationForced)}">
	            	<th:block th:utext="${publication.title}"></th:block>
	            	<span th:title="#{html.ValidatedByOrganizationRepresentative}">
						<span class="fa-solid fa-user-check" style="font-size:14pt;"></span>
					</span>
            	</th:block>
            	<th:block th:if="${#bools.isFalse(publication.manualValidationForced)}"
            	          th:utext="${publication.title}"></th:block>
            </td>
            <td>
            	<th:block th:each="authorship, iAuthorship : ${publication.authorships}">
                    <th:block th:unless="${iAuthorship.first}"
                              th:utext="', '"></th:block>
					<a th:if="${authorship.person.webPageId != null}"
					   th:href="@{/showPublicationStats(webId=${authorship.person.webPageId})}">
	                    <th:block th:utext="${authorship.person.fullName}"></th:block>
					</a>
					<a th:if="${authorship.person.webPageId == null}"
					   th:href="@{/showPublicationStats(dbId=${authorship.person.id})}">
	                    <th:block th:utext="${authorship.person.fullName}"></th:block>
					</a>
            	</th:block>
            </td>
            <td>
            	<th:block th:utext="${publication.type.getLabel()}"></th:block>
            </td>
            <td>
            	<th:block th:utext="${publication.publicationYear}"></th:block>
            </td>
            <td>
            	<th:block th:utext="${publication.wherePublishedShortDescription}"></th:block>
            </td>
            <td th:with="oa = ${publication.openAccess}">
            	<th:block th:if="${oa != null && oa.booleanValue}"
            	          th:utext="#{html.yes}"></th:block>
            	<th:block th:if="${oa != null && !oa.booleanValue}"
            	          th:utext="#{html.no}"></th:block>
            </td>
            <td>
				<a th:href="@{/} + ${publication.pathToDownloadablePDF}"
				   class="noLink"
				   th:unless="${#strings.isEmpty(publication.pathToDownloadablePDF)}">
					<button class="fa-solid fa-file-pdf"
					        th:title="#{html.PdfDocumentFor}"
					        style="font-size:14pt"></button></a>
				<a th:href="@{/} + ${publication.pathToDownloadableAwardCertificate}"
				   class="noLink"
				   th:unless="${#strings.isEmpty(publication.pathToDownloadableAwardCertificate)}">
					<button class="fa-solid fa-award"
					        th:title="#{html.AwardDocumentFor}"
					        style="font-size:14pt"></button></a>
            </td>
            <td>
            	<th:block th:if="${publication.validated}"><i style="color:green" class="fa-solid fa-check-circle">B</i></th:block>
            	<th:block th:unless="${publication.validated}"><i style="color:red"  class="fa-solid fa-triangle-exclamation">A</i></th:block>
            </td>
            <td th:replace="fragments/table :: adminToolButtons(${publication.id}, ${publication.title},
            		#{html.EditPublication1(${publication.title})},
            		#{html.DeletePublication1(${publication.title})},
            		null,
            		id, id, id,
            		@{/exportJson(id=${publication.id},inAttachment=false)} )"></td>
        </tr>
    </tbody>
</table>
<script type="text/javascript" th:inline="javascript">
    $(document).ready(() => {
    	const dtable = initAdministrationTable({
    		columns: 9,
    		order: [ [4, 'desc'], [2, 'asc'], [1, 'asc'] ],
    	});
        /*[# th:if="${changeEnabled}" th:each="publication : ${publications}"]*/
		attachDeletionHandler({
			id: "[[${publication.id}]]",
			url: "[(@{/deletePublication(publication=${publication.id})})]",
			name: [[${publication.title}]],
			questionTitle: [[#{html.DeletePublication1(${publication.title})}]],
			questionText: [[#{html.AreYouSureToDelete(${publication.title})}]],
			successText: [[#{html.PublicationDeleted}]],
			failureText: [[#{html.CannotDeletePublication}]],
	    });
        /*[/]*/
        /*[# th:if="${changeEnabled}"]*/
		attachDeletionHandler({
			selector: "#btDeleteDisplayedPapers",
			name: "all",
			questionTitle: [[#{html.DeleteDisplayedPublications}]],
			questionText: [[#{html.AreYouSureToDeleteAllDisplayedPublications}]],
			confirmButtonText: [[#{html.YesDeleteThem}]],
			failureText: [[#{html.ErrorAllPublicationDeletion}]],
			urlBuilder: () => {
				var list = "";
				dtable.rows( { filter : 'applied'} ).data().each((r) => {
					if (list) {
						list += ",";
					}
					list += r[0];
				});
				var utext = [[@{/deletePublications(id)}]] + '=' + list;
				var hostURL = new URL(window.location.href);
				var u = new URL(utext, hostURL.origin);
				return u.toString();
			}
		});
        /*[/]*/
    });
</script>
</html>